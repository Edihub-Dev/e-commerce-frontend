import{r as l,j as t,m as J}from"./vendor-2d1PFKo4.js";import{z as ye,u as ge,I as be,B as re,w as ie,J as g,K as le,M as Ne,N as X,P as je,Q as we,R as ve,T as Ae,p as Se}from"./index-Bpx0OnSg.js";import{g as Ce,S as ne,f as Ee}from"./postalLookup-DSvPyxsq.js";import{L as _e}from"./loader-circle-DRAKHMK_.js";import"./react-BzrpNAyj.js";const De=(n="",o="")=>({fullName:o||"",mobile:"",email:n,pincode:"",state:"",city:"",addressLine:"",alternatePhone:"",isDefault:!1,latitude:null,longitude:null,formattedAddress:"",isGeoVerified:!1}),oe=255,Y=255,Fe="p2pdeal:checkout:address_draft",ke=/^[6-9]\d{9}$/,b=5500,Le=new Set(["bldg","nr","blk","stn","rd","flr","apt","opp","sec","sct","gn","ind"]),Re=/[\u0900-\u097F]/,Pe=n=>{const o=n.toLowerCase().replace(/^[^a-z\u0900-\u097f]+|[^a-z\u0900-\u097f]+$/gu,"");return!o||o.length<=2||Le.has(o)||Re.test(o)?!1:!/[aeiou]/.test(o)},Ie=async({city:n,state:o,pincode:s})=>{try{const N=encodeURIComponent(`${s||""} ${n||""} ${o||""} India`),c=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&countrycodes=in&q=${N}`,{headers:{Accept:"application/json"}});if(!c.ok)return null;const C=await c.json();if(!Array.isArray(C)||!C.length)return null;const m=C[0],G=Number(m.lat),w=Number(m.lon);return!Number.isFinite(G)||!Number.isFinite(w)?null:{latitude:G,longitude:w,formattedAddress:m.display_name}}catch{return null}},$e=n=>{const o=[],s=String(n.city||"").trim(),N=String(n.addressLine||"").trim(),c=String(n.mobile||"").trim();if(N||o.push("Enter your address line."),s||o.push("Enter your city."),N){const C=N.split(/[^A-Za-z\u0900-\u097F0-9]+/).filter(m=>m.length>=3&&!/\d/.test(m)).filter(Pe);C.length&&o.push(`Replace unclear words so the address is readable: ${C.slice(0,3).join(", ")}.`)}return c&&!ke.test(c)&&o.push("Enter a valid 10-digit mobile number starting with 6-9."),{isValid:o.length===0,errors:o}},qe=()=>{const n=ye(),o=ge(),{user:s}=be(),N=l.useMemo(()=>(s==null?void 0:s.name)||(s==null?void 0:s.username)||(s==null?void 0:s.fullName)||"",[s==null?void 0:s.name,s==null?void 0:s.username,s==null?void 0:s.fullName]),c=l.useCallback(()=>De(s==null?void 0:s.email,N),[s==null?void 0:s.email,N]),{items:C}=re(e=>e.checkout),{addresses:m,loading:G}=re(e=>e.address),[w,P]=l.useState(null),[$,v]=l.useState(!1),[U,V]=l.useState(!1),[r,j]=l.useState(c),[p,F]=l.useState(null),q=l.useRef(""),O=l.useRef(!0),M=l.useRef(!1),T=l.useMemo(()=>{const e=(s==null?void 0:s._id)||(s==null?void 0:s.id)||(s==null?void 0:s.email)||(s==null?void 0:s.phone)||"guest";return`${Fe}:${e}`},[s==null?void 0:s._id,s==null?void 0:s.email,s==null?void 0:s.id,s==null?void 0:s.phone]),k=l.useCallback(()=>{if(!(typeof window>"u"))try{window.localStorage.removeItem(T)}catch(e){console.error("Failed to clear address draft",e)}},[T]);l.useEffect(()=>{if(typeof window>"u"){O.current=!1;return}O.current=!0;try{const e=window.localStorage.getItem(T);if(!e)return;const a=JSON.parse(e);if(a!=null&&a.formState){const i={...c(),...a.formState};j(i),v(a.showForm??!0),F(a.editingAddressId??null),M.current=!0}}catch(e){console.error("Failed to restore address draft",e)}finally{O.current=!1}},[T,c]),l.useEffect(()=>{if(!(typeof window>"u")&&!O.current){if(!$){k();return}try{window.localStorage.setItem(T,JSON.stringify({formState:r,editingAddressId:p,showForm:!0,timestamp:Date.now()}))}catch(e){console.error("Failed to persist address draft",e)}}},[r,p,$,T,k]);const de=l.useCallback(()=>{j(c()),F(null),v(!0),k(),M.current=!1},[c,k]),Q=l.useCallback(()=>{v(!1),j(c()),F(null),k(),M.current=!1},[c,k]),K=l.useMemo(()=>{const e=Ce(r.state)||[];return r.city&&e.length&&!e.includes(r.city)?[...e,r.city]:e},[r.state,r.city]),Z=(e="")=>e.toString().toLowerCase().replace(/&/g,"and").replace(/\./g,"").replace(/\s+/g," ").trim(),ee=l.useCallback((e="")=>{if(!e)return"";const a=Z(e);return ne.find(d=>Z(d)===a)||e},[]);l.useEffect(()=>{n(ie("address")),C.length||(g.error("Your checkout session expired. Start again.",{duration:b}),o("/cart",{replace:!0}))},[n,C.length,o]),l.useEffect(()=>{s!=null&&s.email&&j(e=>({...e,email:e.email||s.email}))},[s==null?void 0:s.email]),l.useEffect(()=>{N&&j(e=>({...e,fullName:e.fullName||N}))},[N]),l.useEffect(()=>{(async()=>{var a;n(le(!0));try{const i=await Ne(),d=Array.isArray(i)?i:((a=i==null?void 0:i.data)==null?void 0:a.data)||(i==null?void 0:i.data)||[];n(X(d))}catch(i){console.error("Failed to fetch addresses",i),n(je(i.message||"Failed to fetch addresses")),g.error(i.message||"Failed to fetch addresses",{duration:b})}finally{n(le(!1))}})()},[n]),l.useEffect(()=>{if(!O.current){if(!m.length)v(!0),P(null),F(null),M.current||j(c());else if(!w){const e=m.find(a=>a.isDefault);P((e==null?void 0:e._id)||m[0]._id),v(!1),M.current=!1}}},[m,w,s==null?void 0:s.email]),l.useEffect(()=>{const e=String(r.pincode||"").trim();if(!e||!/^\d{6}$/.test(e)){q.current="";return}if(e===q.current)return;let a=!0;return(async()=>{var u,A;const d=await Ee(e);if(!a)return;if(!d.success){q.current="",g.error(d.message||"Could not validate this PIN code with India Post.",{duration:b});return}q.current=e;const f=ee(((u=d.data)==null?void 0:u.state)||""),y=((A=d.data)==null?void 0:A.city)||"";j(x=>{if(x.pincode!==e)return x;const I=f||x.state,_=y||x.city;return I===x.state&&_===x.city?x:{...x,state:I,city:_}})})(),()=>{a=!1}},[r.pincode,ee]);const B=l.useMemo(()=>m.find(e=>e._id===w)||null,[m,w]),L="w-full rounded-2xl border border-slate-200 bg-white/95 px-3.5 py-3 text-sm sm:text-[15px] text-secondary placeholder:text-slate-400 focus:border-primary/60 focus:outline-none focus:ring-2 focus:ring-primary/40 transition disabled:cursor-not-allowed disabled:bg-slate-100 disabled:text-slate-400 disabled:opacity-60",ce=`${L} min-h-[132px] resize-none leading-6`,te="w-full sm:w-auto inline-flex h-12 items-center justify-center rounded-full border border-slate-200 px-5 text-sm font-semibold text-secondary transition hover:border-primary/40 hover:bg-primary/5 hover:text-primary",se="w-full sm:w-auto inline-flex h-12 items-center justify-center rounded-full bg-primary px-6 text-sm font-semibold text-white shadow-sm shadow-primary/25 transition hover:bg-primary-dark disabled:cursor-not-allowed disabled:opacity-60",me="group block rounded-2xl border border-slate-200 bg-white/80 p-4 sm:p-5 shadow-sm transition hover:border-primary/50 hover:shadow-md",W="rounded-2xl border border-slate-200 bg-white/95 p-4 shadow-sm shadow-slate-200/40 sm:p-5 space-y-4",ae="grid gap-4 min-[480px]:grid-cols-2 sm:gap-5",R="flex flex-col gap-1.5 text-sm font-medium text-secondary/80",E=e=>{const{name:a,value:i,type:d,checked:f}=e.target,y=d==="checkbox"?f:i;j(u=>({...u,[a]:y,...a==="state"&&u.state!==y?{city:""}:{},...a==="addressLine"||a==="city"||a==="state"||a==="pincode"?{isGeoVerified:!1,latitude:null,longitude:null,formattedAddress:""}:{}}))},ue=async e=>{var i,d,f,y,u,A,x,I;e.preventDefault(),V(!0);let a={...r,isDefault:p!==null?r.isDefault:r.isDefault||m.length===0};try{const _=$e(r);if(!_.isValid){_.errors.forEach(D=>g.error(D,{duration:b})),V(!1);return}a.addressLine.length>oe&&(a.addressLine=a.addressLine.slice(0,oe));const z=await Ie({city:a.city,state:a.state,pincode:a.pincode});z&&(a.latitude=z.latitude,a.longitude=z.longitude,a.formattedAddress=z.formattedAddress.slice(0,Y).trim(),a.formattedAddress||delete a.formattedAddress,a.isGeoVerified=!0);let S;const h={...a};if(h.email=((i=h.email)==null?void 0:i.trim())||((d=s==null?void 0:s.email)==null?void 0:d.trim())||"",!h.email){g.error("Email is required for delivery updates.",{duration:b}),V(!1);return}["latitude","longitude"].forEach(D=>{(h[D]===null||h[D]===void 0)&&delete h[D]}),(f=h.formattedAddress)!=null&&f.trim()||delete h.formattedAddress,((y=h.formattedAddress)==null?void 0:y.length)>Y&&(h.formattedAddress=h.formattedAddress.slice(0,Y).trim()),(u=h.alternatePhone)!=null&&u.trim()||delete h.alternatePhone,p?(S=await ve(p,h),g.success("Address updated successfully",{duration:b})):(S=await Ae(h),g.success("Address saved successfully",{duration:b}));const H=Array.isArray(S)?S:((A=S==null?void 0:S.data)==null?void 0:A.data)||(S==null?void 0:S.data)||[];if(n(X(H)),!p&&H.length){const D=H[H.length-1];P((D==null?void 0:D._id)||null)}p&&P(p),v(!1),j(c()),k(),F(null)}catch(_){console.error("Failed to save address",_),g.error(((I=(x=_.response)==null?void 0:x.data)==null?void 0:I.message)||_.message||"Failed to save address",{duration:b})}finally{V(!1)}},fe=e=>{F(e._id),j({fullName:e.fullName||"",mobile:e.mobile||"",email:e.email||"",pincode:e.pincode||"",state:e.state||"",city:e.city||"",addressLine:e.addressLine||"",alternatePhone:e.alternatePhone||"",isDefault:!!e.isDefault,latitude:e.latitude??null,longitude:e.longitude??null,formattedAddress:e.formattedAddress||"",isGeoVerified:!!e.isGeoVerified}),v(!0)},xe=async e=>{var i,d,f;if(window.confirm(`Delete address for ${e.fullName}? This action cannot be undone.`))try{const y=e._id||e.id;if(!y){g.error("Unable to delete address: missing identifier",{duration:b});return}const u=await we(y),A=Array.isArray(u)?u:((i=u==null?void 0:u.data)==null?void 0:i.data)||(u==null?void 0:u.data)||[];if(n(X(A)),g.success("Address removed",{duration:b}),p===e._id&&(F(null),j(c()),v(!1)),!A.length)P(null),v(!0);else if(w===e._id||w===e.id){const x=A.find(I=>I.isDefault);P((x==null?void 0:x._id)||A[0]._id)}}catch(y){console.error("Failed to delete address",y),g.error(((f=(d=y.response)==null?void 0:d.data)==null?void 0:f.message)||y.message||"Failed to delete address",{duration:b})}},he=()=>{if($&&!m.length){g.error("Please add an address before continuing",{duration:b});return}if(!B){g.error("Select an address to proceed",{duration:b});return}n(Se(B)),n(ie("payment")),o("/checkout/payment")},pe=$?p?"Cancel editing":"Close form":"+ Add New Address";return t.jsx("div",{className:"min-h-screen bg-slate-50",children:t.jsx("div",{className:"mx-auto w-full max-w-6xl px-4 py-6 sm:px-6 sm:py-8 lg:px-8 lg:py-10",children:t.jsxs("div",{className:"grid gap-8 lg:grid-cols-[2fr,1fr]",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsx("section",{className:"rounded-3xl border border-slate-200 bg-white/80 px-5 py-5 shadow-sm backdrop-blur sm:p-6",children:t.jsxs("header",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsx("h2",{className:"text-xl font-semibold text-secondary",children:"Delivery Address"}),t.jsx("p",{className:"text-sm text-medium-text",children:"Choose an existing address or add a new one."})]}),t.jsx("span",{className:"inline-flex items-center rounded-full border border-primary/20 bg-primary/10 px-4 py-1 text-sm font-semibold text-primary",children:"Step 2 of 4"})]})}),G?t.jsx("div",{className:"rounded-3xl border border-slate-200 bg-white p-6 text-center text-medium-text shadow-sm",children:"Loading your saved addresses..."}):t.jsxs("section",{className:W,children:[t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsx("h3",{className:"text-base font-semibold text-secondary",children:"Saved Addresses"}),t.jsx("p",{className:"text-xs text-medium-text",children:"Tap an address to use it for this order."})]}),t.jsx("button",{type:"button",onClick:()=>{$?Q():(F(null),j(c()),v(!0),k())},className:"inline-flex w-full items-center justify-center gap-2 rounded-full border border-primary/30 bg-primary/5 px-4 py-2 text-sm font-semibold text-primary transition hover:border-primary/60 hover:bg-primary/10 sm:w-auto",children:pe})]}),t.jsx("div",{className:"mt-4 space-y-4",children:m.length?m.map((e,a)=>{const i=e._id||e.id||a,d=w===e._id||w===e.id;return t.jsx("label",{className:`${me} ${d?"border-primary bg-primary/5 ring-2 ring-primary/30":""}`,children:t.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("input",{type:"radio",name:"selectedAddress",checked:d,onChange:()=>P(e._id||e.id),className:"mt-1 h-4 w-4 text-primary focus:ring-primary"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3",children:[t.jsx("h3",{className:"text-base font-semibold text-secondary",children:e.fullName}),e.isDefault&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-primary/10 px-2.5 py-1 text-xs font-semibold text-primary",children:"Default"})]}),t.jsxs("p",{className:"text-sm leading-6 text-medium-text",children:[e.addressLine,", ",e.city,","," ",e.state," - ",e.pincode]}),t.jsxs("div",{className:"flex flex-wrap gap-3 text-xs text-medium-text",children:[t.jsx("span",{className:"font-semibold text-secondary",children:"Mobile:"}),t.jsx("span",{children:e.mobile}),e.alternatePhone?t.jsxs("span",{children:[t.jsx("span",{className:"font-semibold text-secondary",children:"Alternate:"})," ",e.alternatePhone]}):null]}),t.jsxs("p",{className:"text-xs text-slate-400",children:["Email: ",e.email]})]})]}),t.jsxs("div",{className:"flex gap-2 sm:pr-1",children:[t.jsx("button",{type:"button",onClick:f=>{f.preventDefault(),f.stopPropagation(),fe(e)},className:"inline-flex items-center rounded-full border border-primary/30 px-3 py-1.5 text-xs font-semibold text-primary transition hover:border-primary/60 hover:bg-primary/10",children:"Edit"}),t.jsx("button",{type:"button",onClick:f=>{f.preventDefault(),f.stopPropagation(),xe(e)},className:"inline-flex items-center rounded-full border border-rose-200 px-3 py-1.5 text-xs font-semibold text-rose-500 transition hover:border-rose-300 hover:bg-rose-50",children:"Remove"})]})]})},i)}):t.jsx("div",{className:"rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-medium-text",children:"You have not added any delivery addresses yet."})})]}),$&&t.jsxs(J.form,{onSubmit:ue,initial:{opacity:0,y:16},animate:{opacity:1,y:0},className:`${W} shadow-lg`,children:[t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-secondary",children:p?"Update Address":"Add New Address"}),p?t.jsx("span",{className:"text-xs text-medium-text",children:"Editing existing address"}):null]}),t.jsxs("div",{className:`mt-5 ${ae}`,children:[t.jsxs("label",{className:R,children:["Full Name",t.jsx("input",{type:"text",name:"fullName",value:r.fullName,onChange:E,required:!0,className:L})]}),t.jsxs("label",{className:R,children:["Mobile Number",t.jsx("input",{type:"tel",name:"mobile",value:r.mobile,onChange:E,required:!0,className:L})]}),t.jsxs("label",{className:R,children:["Email",t.jsx("input",{type:"email",name:"email",value:r.email,onChange:E,required:!0,className:L})]}),t.jsxs("label",{className:R,children:["Pincode",t.jsx("input",{type:"text",name:"pincode",value:r.pincode,onChange:E,required:!0,className:L})]}),t.jsxs("label",{className:R,children:["State",t.jsxs("select",{name:"state",value:r.state,onChange:E,required:!0,className:`${L} appearance-none`,children:[t.jsx("option",{value:"",children:"Select state"}),ne.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("label",{className:R,children:["City",t.jsxs("select",{name:"city",value:r.city,onChange:E,required:!0,disabled:!r.state&&!K.length,className:`${L} appearance-none`,children:[t.jsx("option",{value:"",children:r.state||K.length?"Select city":"Select state first"}),K.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),t.jsxs("label",{className:`${R} mt-4`,children:["Address Line",t.jsx("textarea",{name:"addressLine",value:r.addressLine,onChange:E,required:!0,className:ce})]}),r.isGeoVerified?t.jsx("p",{className:"mt-2 text-xs text-emerald-600",children:"Address verified via map service."}):null,t.jsx("p",{className:"mt-2 text-xs text-medium-text",children:"Enter the full delivery address as it should appear on the package. Our team will review it before shipping."}),t.jsxs("div",{className:`mt-4 ${ae}`,children:[t.jsxs("label",{className:R,children:["Alternate Phone (optional)",t.jsx("input",{type:"tel",name:"alternatePhone",value:r.alternatePhone,onChange:E,className:L})]}),t.jsxs("label",{className:"flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-secondary",children:[t.jsx("input",{type:"checkbox",name:"isDefault",checked:r.isDefault,onChange:E,className:"h-4 w-4 text-primary focus:ring-primary"}),"Set as default delivery address"]})]}),t.jsxs("div",{className:"mt-6 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end",children:[t.jsx("button",{type:"button",onClick:de,className:te,children:"Reset"}),t.jsx("button",{type:"button",onClick:Q,className:te,children:"Cancel"}),t.jsxs(J.button,{type:"submit",whileHover:{scale:1.02},whileTap:{scale:.98},disabled:U,className:se,children:[U?p?"Updating...":"Saving...":p?"Save Changes":"Save Address",U&&t.jsx(_e,{className:"ml-2 h-4 w-4 animate-spin"})]})]})]}),t.jsx("section",{className:W,children:t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[t.jsx("div",{className:"text-sm text-medium-text",children:B?`Delivering to ${B.fullName}`:"Select or add an address to proceed."}),t.jsx(J.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:he,className:se,children:"Continue to Payment"})]})})]}),t.jsx("aside",{className:"space-y-4",children:t.jsxs("div",{className:"rounded-3xl border border-slate-200 bg-white p-5 shadow-sm sm:p-6 lg:sticky lg:top-8",children:[t.jsx("h3",{className:"text-lg font-semibold text-secondary",children:"Why we need this?"}),t.jsxs("ul",{className:"mt-4 space-y-3 text-sm text-medium-text",children:[t.jsx("li",{children:"• Ensure accurate delivery of your order."}),t.jsx("li",{children:"• Provide updates on shipping and delivery status."}),t.jsx("li",{children:"• Offer faster checkout for future purchases."})]})]})})]})})})};export{qe as default};
