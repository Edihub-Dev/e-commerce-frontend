import{r as m,j as e,m as E}from"./vendor-2d1PFKo4.js";import{I as oe,a3 as ce,M as me,J as c,T as ue,R as xe,Q as fe}from"./index-Bpx0OnSg.js";import{p as pe,d as P}from"./animations-CMxtCVje.js";import{g as be,S as _,f as ge,v as H}from"./postalLookup-DSvPyxsq.js";import{P as W}from"./pencil-line-CoX3LYzN.js";import{L as M}from"./loader-circle-DRAKHMK_.js";import"./react-BzrpNAyj.js";const D=()=>({fullName:"",mobile:"",addressLine:"",city:"",state:"",pincode:""}),K=/^[6-9]\d{9}$/,J=/^[A-Za-z\s.'-]{2,}$/,Y=/^[1-9]\d{5}$/,Q=async({city:s,state:x,pincode:w})=>{try{const p=encodeURIComponent(`${w||""} ${s||""} ${x||""} India`),S=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&countrycodes=in&q=${p}`,{headers:{Accept:"application/json"}});if(!S.ok)return null;const h=await S.json();if(!Array.isArray(h)||!h.length)return null;const b=h[0],N=Number(b.lat),L=Number(b.lon);return!Number.isFinite(N)||!Number.isFinite(L)?null:{latitude:N,longitude:L,formattedAddress:b.display_name}}catch{return null}},Z=s=>{const x=[],w=String(s.fullName||"").trim();(!w||w.length<2)&&x.push("Enter the recipient's full name.");const p=String(s.addressLine||"").trim();(!p||p.length<5)&&x.push("Enter a complete address line (min 5 characters).");const S=String(s.mobile||"").trim();K.test(S)||x.push("Enter a valid 10-digit mobile number starting with 6-9.");const h=String(s.city||"").trim();J.test(h)||x.push("Enter a valid city name using only letters.");const b=String(s.state||"").trim();J.test(b)||x.push("Enter a valid state name using only letters.");const N=String(s.pincode||"").trim();return Y.test(N)||x.push("Enter a valid 6-digit PIN code."),{isValid:x.length===0,errors:x}},Se=()=>{const{user:s,updateProfile:x}=oe(),[w,p]=m.useState([]),[S,h]=m.useState(!0),[b,N]=m.useState(null),[L,F]=m.useState(!1),[y,j]=m.useState(!1),[i,A]=m.useState(D),[$,I]=m.useState(!1),[G,R]=m.useState((s==null?void 0:s.name)||""),[T,k]=m.useState(s!=null&&s.mobile?s.mobile.replace(/\D/g,"").slice(-10):""),[O,z]=m.useState(!1),q=m.useRef(""),ee=()=>({fullName:(s==null?void 0:s.name)||"",mobile:s!=null&&s.mobile?s.mobile.replace(/\D/g,"").slice(-10):"",addressLine:"",city:"",state:"",pincode:""}),U=m.useMemo(()=>{const t=be(i.state)||[];return i.city&&t.length&&!t.includes(i.city)?[...t,i.city]:t},[i.state,i.city]),X=(t="")=>t.toString().toLowerCase().replace(/&/g,"and").replace(/\./g,"").replace(/\s+/g," ").trim(),te=(t="")=>{if(!t)return"";const n=X(t);return _.find(a=>X(a)===n)||t};m.useEffect(()=>{(async()=>{var n;h(!0);try{const r=await me(),a=Array.isArray(r)?r:((n=r==null?void 0:r.data)==null?void 0:n.data)||(r==null?void 0:r.data)||[];p(a)}catch(r){console.error("Failed to fetch addresses",r),c.error(r.message||"Failed to load saved addresses.")}finally{h(!1)}})()},[]),m.useEffect(()=>{R((s==null?void 0:s.name)||""),k(s!=null&&s.mobile?s.mobile.replace(/\D/g,"").slice(-10):"")},[s]),m.useEffect(()=>{const t=String(i.pincode||"").trim();if(!Y.test(t)||t===q.current)return;let n=!0;return q.current=t,(async()=>{const a=await ge(t);if(!n)return;if(!a.success){c.error(a.message);return}const u=te(a.data.state),o=(a.data.city||"").trim();!u&&!o||A(l=>{const g=u||l.state,d=o||l.city;return l.state===g&&l.city===d?l:{...l,state:g,city:d}})})(),()=>{n=!1}},[i.pincode]);const se=t=>{F(!1),N(t._id||t.id),A({fullName:t.fullName||"",mobile:t.mobile||"",addressLine:t.addressLine||"",city:t.city||"",state:t.state||"",pincode:t.pincode||""})},V=()=>{N(null),A(D())},ae=()=>{N(null),A(ee()),F(!0)},B=()=>{F(!1),A(D())},f=t=>{const{name:n,value:r}=t.target;A(a=>({...a,[n]:r,...n==="state"&&a.state!==r?{city:""}:{}}))},re=async t=>{var a,u,o;if(t.preventDefault(),!b)return;const n=Z(i);if(!n.isValid){n.errors.forEach(l=>c.error(l));return}j(!0);const r={fullName:i.fullName.trim(),mobile:i.mobile.trim(),addressLine:i.addressLine.trim(),city:i.city.trim(),state:i.state.trim(),pincode:i.pincode.trim()};try{const l=await H({pincode:r.pincode,state:r.state,city:r.city});if(!l.success){c.error(l.message),j(!1);return}r.state=l.data.state,r.city=l.data.city;const g=await Q(r);g&&(r.latitude=g.latitude,r.longitude=g.longitude,r.formattedAddress=g.formattedAddress,r.isGeoVerified=!0);const d=await xe(b,r),C=Array.isArray(d)?d:((a=d==null?void 0:d.data)==null?void 0:a.data)||(d==null?void 0:d.data)||[];p(C),c.success("Address updated successfully."),V()}catch(l){console.error("Failed to update address",l),c.error(((o=(u=l.response)==null?void 0:u.data)==null?void 0:o.message)||l.message||"Failed to update address.")}finally{j(!1)}},ie=async t=>{var u,o,l,g;t.preventDefault();const n=Z(i);if(!n.isValid){n.errors.forEach(d=>c.error(d));return}const r=(u=s==null?void 0:s.email)==null?void 0:u.trim();if(!r){c.error("Email is required to save an address.");return}j(!0);const a={fullName:i.fullName.trim(),mobile:i.mobile.trim(),addressLine:i.addressLine.trim(),city:i.city.trim(),state:i.state.trim(),pincode:i.pincode.trim(),email:r,isDefault:!0};try{const d=await H({pincode:a.pincode,state:a.state,city:a.city});if(!d.success){c.error(d.message||"Failed to validate address."),j(!1);return}a.state=d.data.state,a.city=d.data.city;const C=await Q(a);C&&(a.latitude=C.latitude,a.longitude=C.longitude,a.formattedAddress=C.formattedAddress,a.isGeoVerified=!0);const v=await ue(a),de=Array.isArray(v)?v:((o=v==null?void 0:v.data)==null?void 0:o.data)||(v==null?void 0:v.data)||[];p(de),c.success("Address added successfully."),F(!1),A(D())}catch(d){console.error("Failed to add address",d),c.error(((g=(l=d.response)==null?void 0:l.data)==null?void 0:g.message)||d.message||"Failed to add address.")}finally{j(!1)}},ne=async t=>{var r,a,u;if(!(!t||!window.confirm("Remove this address? This action cannot be undone."))){j(!0);try{const o=await fe(t),l=Array.isArray(o)?o:((r=o==null?void 0:o.data)==null?void 0:r.data)||(o==null?void 0:o.data)||[];p(l),c.success("Address removed."),b===t&&V()}catch(o){console.error("Failed to delete address",o),c.error(((u=(a=o.response)==null?void 0:a.data)==null?void 0:u.message)||o.message||"Failed to delete address.")}finally{j(!1)}}},le=async t=>{t.preventDefault();const n=G.trim();if(n.length<2){c.error("Name must be at least 2 characters.");return}const r=T.replace(/\D/g,"").slice(-10);if(!K.test(r)){c.error("Enter a valid 10-digit mobile number starting with 6.");return}const a={};if(n!==(s==null?void 0:s.name)&&(a.name=n),r!==(s==null?void 0:s.mobile)&&(a.mobile=r),!Object.keys(a).length){c.info("No changes to save."),I(!1);return}z(!0);try{await x(a),I(!1)}catch(u){console.error("Failed to update profile name",u)}finally{z(!1)}};return e.jsxs(E.div,{className:"container mx-auto px-4 py-10 sm:py-12 lg:py-16",variants:pe,initial:"initial",animate:"animate",exit:"exit",children:[e.jsx(E.h1,{className:"mb-8 text-3xl font-bold text-secondary",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{delay:.2},children:"My Profile"}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[1fr,2fr] lg:gap-8 lg:items-start",children:[e.jsx(E.div,{className:"self-start rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",variants:P,initial:"initial",animate:"animate",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-secondary",children:"Account"})}),!$&&e.jsx("button",{type:"button",onClick:()=>I(!0),className:"inline-flex items-center justify-center gap-2 rounded-lg border border-primary/20 bg-primary/10 px-3 py-2 text-xs font-semibold text-primary hover:bg-primary/20",children:e.jsx(W,{className:"h-4 w-4"})})]}),$?e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Name",e.jsx("input",{value:G,onChange:t=>R(t.target.value),className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"Enter your name",maxLength:100})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Mobile Number",e.jsxs("div",{className:"mt-2 flex w-full rounded-lg border border-slate-200 focus-within:border-primary focus-within:ring-2 focus-within:ring-primary/30",children:[e.jsx("span",{className:"inline-flex items-center rounded-l-lg bg-slate-100 px-3 text-sm text-secondary/70",children:"+91"}),e.jsx("input",{value:T,onChange:t=>{const n=t.target.value.replace(/\D/g,"").slice(0,10);k(n)},className:"flex-1 rounded-r-lg border-0 px-3 py-2 text-sm focus:outline-none",placeholder:"10-digit mobile",inputMode:"numeric",maxLength:10})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:justify-end",children:[e.jsx("button",{type:"button",className:"rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-secondary hover:bg-slate-50",onClick:()=>{I(!1),R((s==null?void 0:s.name)||""),k(s!=null&&s.mobile?s.mobile.replace(/\D/g,"").slice(-10):"")},disabled:O,children:"Cancel"}),e.jsx("button",{type:"submit",className:"inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-70",disabled:O,children:O?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save"})]})]}):e.jsxs("dl",{className:"grid gap-3 text-sm text-medium-text",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("dt",{className:"font-medium text-secondary/80",children:"Name:"}),e.jsx("dd",{className:"text-secondary text-base",children:(s==null?void 0:s.name)||"-"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("dt",{className:"font-medium text-secondary/80",children:"Email:"}),e.jsx("dd",{className:"select-text text-secondary",children:(s==null?void 0:s.email)||"-"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("dt",{className:"font-medium text-secondary/80",children:"Mobile:"}),e.jsx("dd",{className:"text-secondary",children:s!=null&&s.mobile?s.mobile.startsWith("+")?s.mobile:`+91 ${s.mobile}`:"-"})]})]})]})}),e.jsxs(E.div,{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",variants:P,initial:"initial",animate:"animate",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-secondary",children:"Saved Addresses"})}),e.jsxs("div",{className:"flex gap-2",children:[L?e.jsx("button",{type:"button",onClick:B,className:"inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-secondary hover:bg-slate-50",disabled:y,children:"Cancel"}):null,e.jsx("button",{type:"button",onClick:ae,className:"inline-flex items-center justify-center gap-2 rounded-lg border border-primary/20 bg-primary/10 px-3 py-1.5 text-xs font-semibold text-primary hover:bg-primary/20 disabled:cursor-not-allowed disabled:opacity-70",disabled:y,children:"+ Add Address"})]})]}),e.jsx("div",{className:"mt-5 space-y-4",children:S?e.jsxs("div",{className:"flex items-center justify-center rounded-xl border border-slate-100 bg-slate-50 py-10 text-sm text-medium-text",children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin text-primary"}),"Loading saved addresses..."]}):e.jsxs(e.Fragment,{children:[L&&e.jsx(E.div,{variants:P,initial:"initial",animate:"animate",className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:e.jsxs("form",{className:"space-y-4",onSubmit:ie,children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Full Name",e.jsx("input",{name:"fullName",value:i.fullName,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"Recipient name"})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Mobile Number",e.jsx("input",{name:"mobile",value:i.mobile,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"10-digit mobile",maxLength:10})]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Address",e.jsx("textarea",{name:"addressLine",value:i.addressLine,onChange:f,className:"mt-2 h-20 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"House number, street, locality"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["State",e.jsxs("select",{name:"state",value:i.state,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",children:[e.jsx("option",{value:"",children:"Select state"}),_.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["City",e.jsxs("select",{name:"city",value:i.city,onChange:f,disabled:!i.state,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 disabled:cursor-not-allowed disabled:bg-slate-100",children:[e.jsx("option",{value:"",children:i.state?"Select city":"Select state first"}),U.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80 md:col-span-1",children:["PIN Code",e.jsx("input",{name:"pincode",value:i.pincode,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"6-digit PIN",maxLength:6})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end",children:[e.jsx("button",{type:"button",onClick:B,className:"rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-secondary hover:bg-slate-50",disabled:y,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:y,className:"inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-70",children:y?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save address"})]})]})}),w.length?w.map(t=>{const n=t._id||t.id,r=b===n;return e.jsx(E.div,{variants:P,initial:"initial",animate:"animate",className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:r?e.jsxs("form",{className:"space-y-4",onSubmit:re,children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Full Name",e.jsx("input",{name:"fullName",value:i.fullName,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"Recipient name"})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Mobile Number",e.jsx("input",{name:"mobile",value:i.mobile,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"10-digit mobile",maxLength:10})]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["Address",e.jsx("textarea",{name:"addressLine",value:i.addressLine,onChange:f,className:"mt-2 h-20 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"House number, street, locality"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["State",e.jsxs("select",{name:"state",value:i.state,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",children:[e.jsx("option",{value:"",children:"Select state"}),_.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80",children:["City",e.jsxs("select",{name:"city",value:i.city,onChange:f,disabled:!i.state,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 disabled:cursor-not-allowed disabled:bg-slate-100",children:[e.jsx("option",{value:"",children:i.state?"Select city":"Select state first"}),U.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("label",{className:"text-sm font-medium text-secondary/80 md:col-span-1",children:["PIN Code",e.jsx("input",{name:"pincode",value:i.pincode,onChange:f,className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30",placeholder:"6-digit PIN",maxLength:6})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end",children:[e.jsx("button",{type:"button",onClick:V,className:"rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-secondary hover:bg-slate-50",disabled:y,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:y,className:"inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-70",children:y?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save changes"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold text-secondary",children:t.fullName}),t.mobile?e.jsxs("p",{className:"text-sm text-medium-text",children:["Phone: ",t.mobile]}):null,e.jsxs("p",{className:"text-xs text-slate-400",children:["Email: ",t.email||(s==null?void 0:s.email)||"-"]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>se(t),className:"inline-flex items-center justify-center gap-2 rounded-lg border border-primary/20 bg-primary/10 px-3 py-1.5 text-xs font-semibold text-primary hover:bg-primary/20",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>ne(t._id||t.id),className:"inline-flex items-center justify-center gap-2 rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-600 hover:border-rose-300 hover:bg-rose-100",disabled:y,children:"Remove"})]})]}),e.jsxs("div",{className:"flex items-start gap-2 text-sm text-medium-text",children:[e.jsx(ce,{className:"mt-0.5 h-4 w-4 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{children:t.addressLine}),e.jsxs("p",{children:[t.city,", ",t.state," -"," ",t.pincode]})]})]}),t.isGeoVerified?e.jsx("p",{className:"text-xs font-medium text-emerald-600",children:"âœ“ Location verified"}):null]})},n)}):e.jsx("div",{className:"rounded-xl border border-dashed border-slate-200 bg-slate-50 py-12 text-center text-sm text-medium-text",children:'No saved addresses yet. Use "+ Add Address" to create your first one.'})]})})]})]})]})};export{Se as default};
